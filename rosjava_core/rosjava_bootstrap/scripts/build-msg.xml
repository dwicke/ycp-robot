<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<project default="default" name="java"
    xmlns:artifact="antlib:org.apache.maven.artifact.ant">
  <echo message="Properties: ${properties}"/>

  <fail message="properties file does not exist: ${properties}">
     <condition>
       <not>
         <available file="${properties}" property="properties.present"/>
       </not>
     </condition>
   </fail>

  <property file="${properties}"/>

  <property name="base" location="${ros.home}/rosjava" />
  <property name="build" location="${base}/build/${ros.package}" />
  <property name="gen-msg" location="${base}/gen/msg/${ros.package}" />
  <property name="gen-srv" location="${base}/gen/srv/${ros.package}" />
  <property name="lib" location="${base}/lib" />
  <property name="jar" location="${ros.artifact.built}" />

  <import file="${ros.maven.ant.include}" />

  <path id="classpath">
    <pathelement path="${ros.compile.classpath}" />
  </path>

  <target name="default" depends="jar" />

  <target name="init">
    <mkdir dir="${build}" />
    <mkdir dir="${lib}" />
  </target>

  <target name="clean">
    <delete dir="${gen-msg}" />
    <delete dir="${gen-srv}" />
    <delete dir="${build}" />
    <delete file="${jar}" />
  </target>

  <target name="check-gen-msg-skip">
    <available file="${gen-msg}" type="dir" property="gen-msg.skip" />
  </target>

  <target name="gen-msg" depends="check-gen-msg-skip" unless="gen-msg.skip">
    <mkdir dir="${gen-msg}" />
    <exec executable="rosrun">
      <arg value="rosjava_bootstrap" />
      <arg value="java_msgs.py" />
      <arg value="-o ${gen-msg}" />
      <arg value="${ros.package}" />
    </exec>
  </target>

  <target name="check-gen-srv-skip">
    <available file="${gen-srv}" type="dir" property="gen-srv.skip" />
  </target>

  <target name="gen-srv" depends="check-gen-srv-skip" unless="gen-srv.skip">
    <mkdir dir="${gen-srv}" />
    <exec executable="rosrun">
      <arg value="rosjava_bootstrap" />
      <arg value="java_srvs.py" />
      <arg value="-o ${gen-srv}" />
      <arg value="${ros.package}" />
    </exec>
  </target>

  <target name="compile" depends="init, gen-msg, gen-srv">
    <javac debug="true" debuglevel="${debuglevel}" destdir="${build}" includeantruntime="false">
      <classpath refid="classpath" />
      <src path="${gen-msg}" />
      <src path="${gen-srv}" />
    </javac>
  </target>

  <target name="jar" depends="compile">
    <jar destfile="${jar}">
      <fileset dir="${build}" />
      <manifest>
        <!-- OSGi properties -->
        <attribute name='Bundle-ManifestVersion' value='2' />
        <attribute name='Bundle-SymbolicName' value='org.ros.message.${ros.package}' />
        <attribute name='Bundle-Version' value='0.0.0' />
        <attribute name="Export-Package" value="${ros.osgi.exports}" />
        <attribute name="Import-Package" value="${ros.osgi.imports}" />
        <attribute name="Fragment-Host" value='org.ros.rosjava; bundle-version="[0.0.0,0.1.0)"' />
      </manifest>
    </jar>
  </target>
</project>
